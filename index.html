<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æƒ…ç·’è¦–è¦ºå¯¦é©—å®¤ - è»Œè·¡ä¿®æ­£ç‰ˆ</title>
    <style>
        :root { --primary: #6c5ce7; --bg: #f8f9fa; --danger: #eb4d4b; --warning: #f9ca24; }
        * { box-sizing: border-box; touch-action: none; } /* ç¦ç”¨é»˜èªè§¸æ§é˜²æ­¢å¹²æ“¾ */
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; }
        .card { background: white; width: 100%; max-width: 600px; margin: 10px; padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .mood-tag { font-size: 28px; font-weight: bold; color: var(--primary); text-align: center; margin: 10px 0; }
        .timer-info { text-align: center; color: var(--danger); font-size: 14px; margin-bottom: 10px; }
        .canvas-container { border: 2px solid #eee; border-radius: 15px; overflow: hidden; background: white; }
        canvas { display: block; width: 100%; aspect-ratio: 4 / 3; cursor: crosshair; }
        .controls { background: #f1f2f6; padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        input[type=range] { width: 100%; margin: 10px 0; }
        .btn-next { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 15px; font-size: 18px; font-weight: bold; margin-top: 10px; }
        textarea { width: 100%; height: 80px; margin-top: 10px; border-radius: 10px; border: 1px solid #ddd; padding: 10px; }
    </style>
</head>
<body>

<div class="card">
    <div id="setup-group">
        <input type="text" id="sid" placeholder="è¼¸å…¥å­¸è™Ÿ" style="width:100%; margin-bottom:10px;">
    </div>
    
    <div class="mood-tag" id="mood-label">å¿ƒæƒ…ï¼šå–œ</div>
    <div class="timer-info" id="timer-display">å¯¦éš›ç¹ªè£½ï¼š0.0s</div>

    <div class="controls">
        <label>è‰²å½©ç­†è§¸</label>
        <input type="range" id="colorSlider" min="0" max="359" value="0" oninput="updateBrush()">
        <input type="range" id="sizeSlider" min="2" max="40" value="8" oninput="updateBrush()">
        <div id="brushInd" style="width:10px; height:10px; background:red; border-radius:50%; margin: 0 auto;"></div>
    </div>

    <div class="canvas-container">
        <canvas id="canvas"></canvas>
    </div>

    <textarea id="mood-desc" placeholder="ç°¡å–®æè¿°ä½ çš„é¡è‰²é¸æ“‡..."></textarea>
    <button class="btn-next" id="action-btn" onclick="checkAndNext()">ä¿å­˜ä¸¦ç¹¼çºŒ (1/4) âœ¨</button>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw2dIjqgHfl0zvEAzqrqxgjwZ0S8oIYoX_KrJameLhTOgzPU-7B-5cHpC36NKhmaVXQjg/exec"; // <--- å‹™å¿…æ”¹é€™è£¡ï¼
    
    const moods = ["å–œ", "æ€’", "å“€", "æ¨‚"];
    let step = 0, finalData = [], hasDrawn = false, drawing = false;
    let curHex = "#FF0000", curSize = 8;
    let activeTime = 0, lastTs = 0;
    
    // è»Œè·¡ç´€éŒ„æ ¸å¿ƒ
    let strokeHistory = []; 
    let currentStroke = null;

    const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');

    function updateBrush() {
        const h = document.getElementById('colorSlider').value;
        curSize = document.getElementById('sizeSlider').value;
        curHex = `hsl(${h}, 80%, 50%)`;
        document.getElementById('brushInd').style.background = curHex;
        // å°‡ hsl è½‰å› hex å­˜æª”ç”¨ (ç°¡åŒ–ç‰ˆ)
        ctx.strokeStyle = curHex;
        ctx.lineWidth = curSize;
    }

    function resize() { 
        canvas.width = canvas.parentElement.clientWidth; 
        canvas.height = canvas.width * 0.75; 
        ctx.fillStyle = "white";
        ctx.fillRect(0,0,canvas.width, canvas.height);
    }
    window.onload = resize;

    function getPos(e) {
        const r = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: Math.round(clientX - r.left), y: Math.round(clientY - r.top) };
    }

    // é–‹å§‹ç•«ç•«
    function startDrawing(e) {
        drawing = true;
        hasDrawn = true;
        lastTs = Date.now();
        const {x, y} = getPos(e);
        
        // ã€é—œéµã€‘åˆå§‹åŒ–ç•¶å‰é€™ä¸€ç­†çš„æ•¸æ“šå°è±¡
        currentStroke = {
            size: curSize,
            color: curHex,
            startTime: Date.now(),
            points: [{x, y, t: 0}]
        };
        
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineCap = 'round';
    }

    // ç•«ç•«ä¸­
    function moveDrawing(e) {
        if (!drawing) return;
        const now = Date.now();
        activeTime += (now - lastTs) / 1000;
        lastTs = now;
        document.getElementById('timer-display').innerText = `å¯¦éš›ç¹ªè£½ï¼š${activeTime.toFixed(1)}s`;

        const {x, y} = getPos(e);
        
        // ã€é—œéµã€‘æŒçºŒæŠŠåº§æ¨™é»å¡é€²å»
        if (currentStroke) {
            currentStroke.points.push({ x, y, t: now - currentStroke.startTime });
        }

        ctx.lineTo(x, y);
        ctx.strokeStyle = curHex;
        ctx.lineWidth = curSize;
        ctx.stroke();
    }

    // çµæŸé€™ä¸€ç­†
    function stopDrawing() {
        if (drawing && currentStroke) {
            strokeHistory.push(currentStroke); // ã€é—œéµã€‘æŠŠæ•´ç­†æ•¸æ“šæ¨å…¥æ­·å²ç´€éŒ„
            currentStroke = null;
        }
        drawing = false;
    }

    // äº‹ä»¶ç›£è½ï¼ˆæ»‘é¼  + è§¸æ§ï¼‰
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', moveDrawing);
    window.addEventListener('mouseup', stopDrawing);

    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e); }, {passive:false});
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); moveDrawing(e); }, {passive:false});
    window.addEventListener('touchend', stopDrawing);

    function checkAndNext() {
        const sid = document.getElementById('sid').value;
        if(!sid || !hasDrawn) return alert("è«‹å¡«å¯«å­¸è™Ÿä¸¦ç¹ªåœ–ï¼");

        // å°è£æ•¸æ“š
        const payload = {
            id: sid,
            age: 0, gender: "N/A", group: "TEST",
            mood: moods[step],
            color_seq: "",
            active_time: activeTime.toFixed(1),
            desc: document.getElementById('mood-desc').value,
            stroke_detail: JSON.stringify(strokeHistory), // é€™è£¡æ˜¯éˆé­‚ï¼
            image: canvas.toDataURL('image/jpeg', 0.4)
        };

        finalData.push(payload);
        
        if(step < 3) {
            step++;
            document.getElementById('mood-label').innerText = "å¿ƒæƒ…ï¼š" + moods[step];
            document.getElementById('mood-desc').value = "";
            document.getElementById('action-btn').innerText = `ä¿å­˜ä¸¦ç¹¼çºŒ (${step+1}/4) âœ¨`;
            // é‡ç½®ç•«å¸ƒèˆ‡è®Šæ•¸
            strokeHistory = [];
            activeTime = 0;
            hasDrawn = false;
            ctx.fillStyle = "white";
            ctx.fillRect(0,0,canvas.width, canvas.height);
        } else {
            submit();
        }
    }

    async function submit() {
        const btn = document.getElementById('action-btn');
        btn.disabled = true;
        btn.innerText = "æ•¸æ“šä¸Šå‚³ä¸­...ğŸš€";
        
        try {
            for(let data of finalData) {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            }
            alert("åŒæ­¥å®Œæˆï¼æ„Ÿè¬åƒèˆ‡å¯¦é©—ã€‚");
            location.reload();
        } catch(e) {
            alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€ï¼");
            btn.disabled = false;
        }
    }
    updateBrush();
</script>

</body>
</html>
