<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æƒ…ç·’è¦–è¦ºå¯¦é©—å®¤ - å…¨å¹³å°ç©©å®šç‰ˆ</title>
    <style>
        :root { --primary: #4a69bd; --bg: #f0f2f5; --danger: #e55039; --warning: #fa983a; --success: #78e08f; }
        * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        .card { background: white; width: 100%; max-width: 600px; margin: 15px; padding: 25px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        /* ä½ˆå±€å„ªåŒ– */
        .setup-ui { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        input, select, textarea { font-size: 16px !important; padding: 12px; border: 2px solid #edeff2; border-radius: 12px; outline: none; background: #f8f9fa; }
        input:focus { border-color: var(--primary); background: white; }
        
        .mood-tag { font-size: 36px; font-weight: 800; color: #1e3799; text-align: center; margin: 10px 0; letter-spacing: 2px; }
        .timer-info { text-align: center; color: #82ccdd; font-size: 14px; font-weight: bold; margin-bottom: 15px; }
        
        /* æ§åˆ¶é¢æ¿ */
        .controls-group { background: #f8f9fa; padding: 15px; border-radius: 20px; border: 1px solid #eee; margin-bottom: 15px; }
        .control-item { display: flex; align-items: center; gap: 12px; margin: 10px 0; }
        #colorSlider { flex: 1; -webkit-appearance: none; height: 20px; border-radius: 10px; background: linear-gradient(to right, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00); }
        #colorSlider::-webkit-slider-thumb { -webkit-appearance: none; width: 26px; height: 26px; background: white; border: 4px solid #1e3799; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* ç•«å¸ƒå€ */
        .canvas-container { border: 4px solid #f0f2f5; border-radius: 20px; background: white; position: relative; box-shadow: inset 0 2px 10px rgba(0,0,0,0.05); }
        canvas { display: block; width: 100%; aspect-ratio: 4 / 3; touch-action: none; cursor: crosshair; }
        .toolbar { display: flex; padding: 10px; background: #fff; border-bottom: 1px solid #f0f2f5; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
        .tool-btn { border: none; padding: 8px 16px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-undo { background: var(--warning); color: white; }
        .btn-clear { background: var(--danger); color: white; }
        
        .desc-area { width: 100%; margin-top: 15px; min-height: 90px; border: 2px solid #edeff2; border-radius: 15px; }
        .btn-next { width: 100%; padding: 18px; background: #1e3799; color: white; border: none; border-radius: 18px; cursor: pointer; font-weight: bold; font-size: 20px; margin-top: 15px; box-shadow: 0 5px 15px rgba(30,55,153,0.3); }
        .btn-next:active { transform: translateY(2px); box-shadow: none; }

        /* å…¨è¢å¹•åŠ è¼‰é®ç½© */
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 9999; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 6px solid #f3f3f3; border-top: 6px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <h2 id="loading-status" style="margin-top: 20px; color: #1e3799;">æ­£åœ¨å„²å­˜å¯¦é©—æ•¸æ“š...</h2>
        <div style="width: 70%; height: 10px; background: #eee; border-radius: 5px; margin-top: 15px; overflow: hidden;">
            <div id="progress-bar" style="width: 0%; height: 100%; background: var(--success); transition: width 0.3s;"></div>
        </div>
    </div>

    <div class="card">
        <div id="setup-area" class="setup-ui">
            <input type="text" id="sid" placeholder="å­¸è™Ÿ">
            <input type="number" id="age" placeholder="å¹´é½¡">
            <select id="gender"><option value="å¥³">å¥³</option><option value="ç”·">ç”·</option></select>
        </div>

        <div class="mood-tag" id="mood-label">å¿ƒæƒ…ï¼šå–œ</div>
        <div class="timer-info" id="timer-display">ç¹ªè£½æ™‚é–“ï¼š0.0s</div>

        <div class="controls-group">
            <div class="control-item">
                <input type="range" id="colorSlider" min="0" max="359" value="0" oninput="updateBrush()">
                <div id="colorPreview" style="width: 40px; height: 40px; border-radius: 10px; background: #f00; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"></div>
            </div>
            <div class="control-item">
                <input type="range" id="sizeSlider" min="2" max="60" value="10" oninput="updateBrush()" style="flex: 1;">
                <span id="sizeValue" style="font-weight: bold; width: 30px; text-align: center;">10</span>
            </div>
        </div>

        <div class="canvas-container">
            <div class="toolbar">
                <button class="tool-btn btn-undo" onclick="undo()">â†©ï¸ å¾©åŸ</button>
                <span id="step-info" style="font-size: 13px; color: #999; font-weight: bold;">é€²åº¦ 1/4</span>
                <button class="tool-btn btn-clear" onclick="clearCanvas()">ğŸ—‘ï¸ é‡ç•«</button>
            </div>
            <canvas id="canvas"></canvas>
        </div>

        <textarea id="mood-desc" class="desc-area" placeholder="èªªèªªçœ‹ï¼Œç‚ºä»€éº¼ç”¨é€™äº›é¡è‰²å’Œç­†è§¸ä¾†è¡¨é”é€™ç¨®å¿ƒæƒ…ï¼Ÿ"></textarea>
        <button class="btn-next" id="action-btn" onclick="handleStep()">ä¸‹ä¸€æ­¥</button>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxco7a9N8h1USfXfhmnZD_ktPPCbNNRuN5V-F2mF-iUGu7w0hG0_KIKBZ3JdCLbUOEaXQ/exec";
        const moods = ["å–œ", "æ€’", "å“€", "æ¨‚"];
        let step = 0;
        let finalDataPool = []; // å­˜å„² 4 å€‹éšæ®µçš„æ‰€æœ‰æ•¸æ“š
        
        let drawing = false, hasDrawn = false;
        let curColor = "#FF0000", curSize = 10;
        let strokeHistory = [], currentStroke = null;
        let canvasStates = [];
        let activeStartTime = 0, totalActiveTime = 0;

        const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');

        // åˆå§‹åŒ–ç•«å¸ƒ
        function initCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientWidth * 0.75;
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveState();
        }
        window.onload = initCanvas;
        window.onresize = () => { /* é¿å…ç¸®æ”¾å°è‡´æ•¸æ“šä¸Ÿå¤±ï¼Œä¸å»ºè­°åœ¨å¯¦é©—ä¸­é€”å‹•æ…‹ resize */ };

        function updateBrush() {
            const h = document.getElementById('colorSlider').value;
            curSize = document.getElementById('sizeSlider').value;
            curColor = `hsl(${h}, 80%, 50%)`;
            document.getElementById('colorPreview').style.background = curColor;
            document.getElementById('sizeValue').innerText = curSize;
        }

        function saveState() {
            if (canvasStates.length > 20) canvasStates.shift();
            canvasStates.push(canvas.toDataURL());
        }

        function undo() {
            if (canvasStates.length > 1) {
                canvasStates.pop();
                strokeHistory.pop();
                const img = new Image();
                img.src = canvasStates[canvasStates.length - 1];
                img.onload = () => {
                    ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
            }
        }

        function clearCanvas() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            canvasStates = [];
            strokeHistory = [];
            totalActiveTime = 0;
            hasDrawn = false;
            saveState();
            updateTimerUI();
        }

        // ç¹ªåœ–é‚è¼¯
        function getXY(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: Math.round(clientX - rect.left), y: Math.round(clientY - rect.top) };
        }

        function startDrawing(e) {
            drawing = true; hasDrawn = true;
            activeStartTime = Date.now();
            const {x, y} = getXY(e);
            currentStroke = { color: curColor, size: curSize, points: [{x, y, t: 0}] };
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function moveDrawing(e) {
            if (!drawing) return;
            const {x, y} = getXY(e);
            const now = Date.now();
            const elapsed = (now - activeStartTime) / 1000;
            totalActiveTime += elapsed;
            activeStartTime = now;
            
            currentStroke.points.push({ x, y, t: totalActiveTime.toFixed(3) });
            ctx.lineTo(x, y);
            ctx.strokeStyle = curColor;
            ctx.lineWidth = curSize;
            ctx.lineCap = "round";
            ctx.lineJoin = "round";
            ctx.stroke();
            updateTimerUI();
        }

        function stopDrawing() {
            if (drawing) {
                strokeHistory.push(currentStroke);
                saveState();
            }
            drawing = false;
        }

        function updateTimerUI() {
            document.getElementById('timer-display').innerText = `ç¹ªè£½æ™‚é–“ï¼š${totalActiveTime.toFixed(1)}s`;
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', moveDrawing);
        window.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e); }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); moveDrawing(e); }, {passive: false});
        canvas.addEventListener('touchend', stopDrawing);

        // æ ¸å¿ƒé‚è¼¯ï¼šæ­¥é©Ÿè™•ç†
        function handleStep() {
            const sid = document.getElementById('sid').value.trim();
            const desc = document.getElementById('mood-desc').value.trim();
            const age = document.getElementById('age').value;

            if (!sid || !age || !hasDrawn || desc.length < 2) {
                alert("è«‹å®Œæ•´å¡«å¯«å­¸è™Ÿã€å¹´é½¡ã€é€²è¡Œç¹ªåœ–ä¸¦è¼¸å…¥æƒ³æ³•æè¿°ï¼");
                return;
            }

            // å°‡ç•¶å‰å¿ƒæƒ…æ•¸æ“šå­˜å…¥ Pool
            finalDataPool.push({
                id: sid,
                age: age,
                gender: document.getElementById('gender').value,
                mood: moods[step],
                active_time: totalActiveTime.toFixed(1),
                desc: desc,
                stroke_detail: JSON.stringify(strokeHistory),
                image: canvas.toDataURL('image/jpeg', 0.4) // å£“ç¸®ç‚º JPEG æ¸›å°‘é«”ç©
            });

            if (step < 3) {
                // é€²å…¥ä¸‹ä¸€å€‹å¿ƒæƒ…
                step++;
                document.getElementById('setup-area').style.display = "none";
                document.getElementById('mood-label').innerText = `å¿ƒæƒ…ï¼š${moods[step]}`;
                document.getElementById('step-info').innerText = `é€²åº¦ ${step+1}/4`;
                document.getElementById('mood-desc').value = "";
                if(step === 3) document.getElementById('action-btn').innerText = "é€å‡ºå®Œæ•´å¯¦é©—çµæœ";
                clearCanvas();
                window.scrollTo(0,0);
            } else {
                // å…¨éƒ¨ç•«å®Œï¼Œä¸€æ¬¡æ€§é€£çºŒä¸Šå‚³
                uploadAllData();
            }
        }

        async function uploadAllData() {
            document.getElementById('loading-overlay').style.display = "flex";
            const status = document.getElementById('loading-status');
            const progress = document.getElementById('progress-bar');

            for (let i = 0; i < finalDataPool.length; i++) {
                const data = finalDataPool[i];
                status.innerText = `æ­£åœ¨ä¸Šå‚³ç¬¬ ${i+1}/4 ä»½æ•¸æ“š (${data.mood})...`;
                const prg = ((i + 1) / finalDataPool.length) * 100;
                progress.style.width = `${prg}%`;

                try {
                    // ä½¿ç”¨ fetch ä¸¦åš´æ ¼ç­‰å¾…
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        cache: 'no-cache',
                        body: JSON.stringify(data)
                    });
                    
                    // å¼·åˆ¶å»¶é² 1 ç§’ï¼Œçµ¦æ‰‹æ©Ÿç¶²è·¯ç·©è¡æ™‚é–“ï¼Œé¿å…è«‹æ±‚æ“å¡
                    await new Promise(r => setTimeout(r, 1000));
                } catch (err) {
                    console.error("Upload failed", err);
                }
            }

            status.innerText = "å…¨éƒ¨æ•¸æ“šå„²å­˜æˆåŠŸï¼";
            alert("ğŸ‰ æ„Ÿè¬åƒèˆ‡ï¼å¯¦é©—æ•¸æ“šå·²æˆåŠŸåŒæ­¥ã€‚");
            location.reload();
        }
    </script>
</body>
</html>
